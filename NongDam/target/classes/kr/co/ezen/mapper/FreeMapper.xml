<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

	
	<mapper namespace="kr.co.ezen.mapper.FreeMapper">
	
	<sql id="search">
		<if test="type == 'user_nickname'">
				where user_nickname like concat('%',#{keyword},'%')
			</if> 
			<if test="type == 'free_title'">
				where free_title like concat('%',#{keyword},'%')
			</if>
			
			
	</sql>
		
	<select id="findAll" resultType="kr.co.ezen.entity.Free" parameterType="kr.co.ezen.entity.Criteria">
	
			select * from free 
			<include refid="search"/>
			 order by free_idx desc
			 limit #{pageStart}, #{perPageNum}
	
	</select>
	
		<select id="findfr" resultType="kr.co.ezen.entity.Free" parameterType="kr.co.ezen.entity.Criteria">
        select * from free where free_tag="자유" order by free_idx desc
        limit #{pageStart}, #{perPageNum}	
	</select>
	
	<select id="findqu" resultType="kr.co.ezen.entity.Free" parameterType="kr.co.ezen.entity.Criteria">
        select * from free where free_tag="질문" order by free_idx desc
        limit #{pageStart}, #{perPageNum}	
	</select>
	
	<select id="findByidx" resultType="kr.co.ezen.entity.Free" parameterType="int">
		select * from free where free_idx=#{free_idx} 
		
	</select>
	
	<insert id="insert" parameterType="kr.co.ezen.entity.Free">
	   insert into free (free_idx, free_title, free_content, free_date, free_tag, free_count, user_idx)
	    VALUES (#{free_idx}, #{free_title}, #{free_content}, now(), #{free_tag}, #{free_count}, #{user_idx})
	</insert>
	
	<select id="GetUserIdx" resultType="kr.co.ezen.entity.Free" parameterType="int">
		select user_idx from User where user_nickname=#{user_nickname}
		
	</select>
	
	
	<select id="totalCount" resultType="int" parameterType="kr.co.ezen.entity.Criteria">
		   select count(*) from free natural join User
		   <include refid="search"/>
	</select>
	
	<update id="updatecnt">
	        update free
	        set free_count = free_count + 1
	        where free_idx = #{free_idx};
	</update>
	
	<delete id="deleteByIdx" parameterType="int">
			delete from free where free_idx=#{free_idx}
	</delete>
	
	<update id="updaetByIdx" parameterType="kr.co.ezen.entity.Free">
			update free set free_title=#{free_title}, free_content=#{free_content}, free_tag=#{free_tag}
			where free_idx=#{free_idx}
	</update>
	

	<select id="findAllComment" resultType="kr.co.ezen.entity.FreeComment" parameterType="int">
	
		select * from FreeComment as f left outer join User as u on f.user_idx= u.user_idx
			where free_idx=#{free_idx}
			order by free_parent_idx desc, free_comment_idx
	
	</select>
	
	<insert id="insertComment" parameterType="kr.co.ezen.entity.FreeComment">
	   insert into freeComment (free_idx,free_parent_idx, free_comment_idx, free_comment_time, free_comment_content, free_comment_useable)
	    VALUES (#{free_idx}, #{free_parent_idx}, #{free_comment_idx}, #{free_comment_time}, #{free_comment_content}, 1)
	</insert>
	
	<delete id="deleteCommentByIdx" parameterType="int">
		delete from freeComment where free_parent_idx=#{free_parent_idx}
	</delete>
	
	<update id="updateCommentByIdx" parameterType="kr.co.ezen.entity.FreeComment">
			update freeComment set free_comment_content=#{free_comment_content} 
			where free_idx=#{free_idx}
			
	</update>
	
	</mapper>
	
	